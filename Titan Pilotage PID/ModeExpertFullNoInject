alias: "üöÄ Titan : R√©gulation Master Universelle (ASYNCHRONE & R√âACTIF) CMG"
description: >-
  R√©gulation PI avec chute de puissance ultra-rapide (anti-injection) et mont√©e contr√¥l√©e.
  Incorpore une logique asym√©trique pour prot√©ger le r√©seau et optimiser l'autoconsommation.

triggers:
  - trigger: state
    # REMPLACER CI-DESSOUS : le sensor puissance votre compteur
    entity_id: sensor.shellypro3em_xxxx_energy_meter_0_puissance
  - trigger: state
    entity_id: input_boolean.pilotage_titan_auto
    to: "off"
    id: stop

actions:
  - choose:
      # --- BLOC 1 : ARR√äT DE LA R√âGULATION (Mode Manuel ou Stop) ---
      - conditions:
          - condition: trigger
            id: stop
        sequence:
          # R√©initialisation des calculs et de l'historique pour repartir √† z√©ro au prochain ON
          - action: input_number.set_value
            target:
              entity_id: input_number.titan_consigne_calculee
            data:
              value: 0
          - action: input_number.set_value
            target:
              entity_id: input_number.titan_integral
            data:
              value: 0
          - action: input_text.set_value
            target:
              entity_id: input_text.historique_puissance_titan
            data:
              value: "[]"
          # Commande d'arr√™t physique de la batterie
          - action: izypower_titan_private.stop
            data:
              device_id: f4e87da5be832718cad4e2012a49f56d

      # --- BLOC 2 : R√âGULATION ACTIVE (Mode Auto ON) ---
      - conditions:
          - condition: state
            entity_id: input_boolean.pilotage_titan_auto
            state: "on"
        sequence:
          - variables:
              historique_raw: "{{ states('input_text.historique_puissance_titan') }}"
              
              # R√âCUP√âRATION DE LA MESURE : le sensor puissance votre compteur
              puissance_brute: "{{ states('sensor.shellypro3em_xxxxx_energy_meter_0_puissance') | float(0) }}"
              
              # Traitement du lissage (Moyenne Mobile)
              new_historique: >-
                {% set h = (historique_raw | from_json(default=[])) if
                historique_raw not in ['unknown', 'unavailable', 'none', '']
                else [] %} {% set h_list = h if h is iterable and h is not
                string else [] %} {{ (h_list +
                [puissance_brute])[-fenetre_moyenne:] }}
              
              puissance_filtree: >-
                {{ (new_historique | sum) / (new_historique | count) if
                new_historique | count > 0 else puissance_brute }}
              
              # Calcul de l'√©cart (Erreur) par rapport √† la cible (0W)
              erreur: "{{ puissance_filtree - target_puissance }}"
              
              # Calcul de la part Int√©grale (m√©moire de l'erreur)
              old_integral: "{{ states('input_number.titan_integral') | float(0) }}"
              new_integral: "{{ ([ (old_integral + erreur), 500 ] | min, -500) | max }}"
              
              # Calcul de la correction th√©orique (P + I)
              consigne_actuelle: "{{ states('input_number.titan_consigne_calculee') | float(0) }}"
              correction_brute: "{{ (facteur_p * erreur) + (facteur_i * new_integral) }}"
              
              # --- LOGIQUE ASYM√âTRIQUE DE S√âCURIT√â ---
              # Si on injecte (erreur < 0), on s'autorise √† couper 2500W d'un coup.
              # Si on consomme (erreur > 0), on limite la mont√©e √† 600W pour la stabilit√©.
              max_step: "{{ 2500 if erreur < 0 else 600 }}"
              
              correction_bridee: >-
                {{ ([ ([correction_brute, max_step] | min), -max_step ] | max) }}
              
              # Calcul final de la consigne (Bornes : -2500W √† 3000W)
              nouvelle_consigne: >-
                {{ ([ (consigne_actuelle + correction_bridee) | int, 3000 ] | min, -2500) | max }}

          - if:
              # Activation uniquement si l'√©cart d√©passe la zone morte (deadband)
              - condition: template
                value_template: "{{ (puissance_filtree | abs) > deadband }}"
            then:
              # Enregistrement de la nouvelle consigne dans l'interface
              - action: input_number.set_value
                target:
                  entity_id: input_number.titan_consigne_calculee
                data:
                  value: "{{ nouvelle_consigne }}"
              
              - choose:
                  # CAS : D√©charge (Consommation maison)
                  - conditions:
                      - condition: template
                        value_template: "{{ nouvelle_consigne > 0 }}"
                    sequence:
                      - action: izypower_titan_private.discharge
                        data:
                          device_id: f4e87da5be832718cad4e2012a49f56d
                          power: "{{ nouvelle_consigne }}"
                          soc_limit: 10
                  
                  # CAS : Charge (Surplus solaire)
                  - conditions:
                      - condition: template
                        value_template: "{{ nouvelle_consigne < 0 }}"
                    sequence:
                      - action: izypower_titan_private.charge
                        data:
                          device_id: f4e87da5be832718cad4e2012a49f56d
                          power: "{{ nouvelle_consigne | abs }}"
                          soc_limit: 100

          # --- SAUVEGARDE DES √âTATS POUR LE PROCHAIN CYCLE ---
          - action: input_text.set_value
            target:
              entity_id: input_text.historique_puissance_titan
            data:
              value: "{{ new_historique | to_json }}"
          - action: input_number.set_value
            target:
              entity_id: input_number.titan_integral
            data:
              value: "{{ new_integral }}"

variables:
  # Sensibilit√© via votre slider
  facteur_p: "{{ states('input_number.titan_facteur_p') | float(0.7) }}"
  # Facteur constant pour stabiliser l'erreur r√©siduelle
  facteur_i: 0.2
  # Fen√™tre courte (2) pour une r√©action asym√©trique efficace
  fenetre_moyenne: 2
  # Cible de r√©gulation (0W pour effacer la facture)
  target_puissance: 0
  # Zone de tol√©rance (en Watts) pour √©viter les micro-ajustements
  deadband: 8

mode: restart
