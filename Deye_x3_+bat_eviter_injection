alias: Ajuster puissance Deye x3 pour Ã©viter l'injection (avec batterie)
mode: single

# ðŸ” DÃ©clenche toutes les 15 secondes
trigger:
  - platform: time_pattern
    seconds: "/15"

condition: []

action:
  - variables:
      # ðŸ”‹ Niveau de charge actuel de la batterie (SOC)
      soc_batterie: >
        {{ states("sensor.hyper2000_soc") | float(0) }}

      # âœ… DÃ©termine si la batterie est considÃ©rÃ©e comme "pleine"
      batterie_pleine: >
        {{ soc_batterie >= 95 }}

      # âš¡ Puissance rÃ©seau actuelle (en W, nÃ©gatif = injection)
      puissance_reseau: >
        {{ states("sensor.yourenergyprobe") | float(0) }}

      # ðŸ”¢ RÃ©cupÃ¨re les consignes actuelles des 3 onduleurs Deye
      consigne_deye_1: >
        {{ states("number.inverter1_active_power_regulation") | float(0) }}
      consigne_deye_2: >
        {{ states("number.inverter2_active_power_regulation") | float(0) }}
      consigne_deye_3: >
        {{ states("number.inverter3_active_power_regulation") | float(0) }}

      # âž— RÃ©partition Ã©quitable entre les 3 onduleurs Deye
      facteur_deye: 1 / 3

      # ðŸ”§ Calcul de la nouvelle consigne pour Deye 1
      nouvelle_consigne_deye_1: >
        {% if not batterie_pleine %}
          100  # Si la batterie n'est pas pleine, on injecte Ã  100%
        {% elif puissance_reseau < -50 or puissance_reseau > 50 %}
          # Si on injecte trop ou consomme trop, on corrige la consigne
          {{ consigne_deye_1 + (puissance_reseau * facteur_deye / 100) }}
        {% else %}
          # Sinon, on garde la mÃªme consigne
          {{ consigne_deye_1 }}
        {% endif %}

      # ðŸ”§ MÃªme logique pour Deye 2
      nouvelle_consigne_deye_2: >
        {% if not batterie_pleine %}
          100
        {% elif puissance_reseau < -50 or puissance_reseau > 50 %}
          {{ consigne_deye_2 + (puissance_reseau * facteur_deye / 100) }}
        {% else %}
          {{ consigne_deye_2 }}
        {% endif %}

      # ðŸ”§ Et pour Deye 3
      nouvelle_consigne_deye_3: >
        {% if not batterie_pleine %}
          100
        {% elif puissance_reseau < -50 or puissance_reseau > 50 %}
          {{ consigne_deye_3 + (puissance_reseau * facteur_deye / 100) }}
        {% else %}
          {{ consigne_deye_3 }}
        {% endif %}

      # ðŸ”’ SÃ©curise les valeurs dans une plage [0, 100] pour Deye 1
      consigne_deye_1_limitee: >
        {% set cible = nouvelle_consigne_deye_1 | float(0) %}
        {% if cible < 0 %} 0
        {% elif cible > 100 %} 100
        {% else %} {{ cible | round(0) }} {% endif %}

      # ðŸ”’ Idem pour Deye 2
      consigne_deye_2_limitee: >
        {% set cible = nouvelle_consigne_deye_2 | float(0) %}
        {% if cible < 0 %} 0
        {% elif cible > 100 %} 100
        {% else %} {{ cible | round(0) }} {% endif %}

      # ðŸ”’ Et pour Deye 3
      consigne_deye_3_limitee: >
        {% set cible = nouvelle_consigne_deye_3 | float(0) %}
        {% if cible < 0 %} 0
        {% elif cible > 100 %} 100
        {% else %} {{ cible | round(0) }} {% endif %}

  # âœ… Applique la consigne limitÃ©e Ã  chaque onduleur
  - service: number.set_value
    target:
      entity_id: number.inverter1_active_power_regulation
    data:
      value: "{{ consigne_deye_1_limitee }}"

  - service: number.set_value
    target:
      entity_id: number.inverter2_active_power_regulation
    data:
      value: "{{ consigne_deye_2_limitee }}"

  - service: number.set_value
    target:
      entity_id: number.inverter3_active_power_regulation
    data:
      value: "{{ consigne_deye_3_limitee }}"
